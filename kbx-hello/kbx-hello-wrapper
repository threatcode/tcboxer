#! /bin/sh

set -x

u=$(id -un)

if [ "$u" != 'root' ] ; then
    exec sudo "$0" --from $u "$@"
fi

if [ "$1" = --from ] ; then
    shift
    user=$1
    shift
    userhome=$(getent passwd $user | cut -d: -f6)
fi

arg0=$(basename "$0")
case "$arg0" in
    kbx-hello-*)
	component=${arg0#kbx-hello-}
	;;
    *)
	component=$1
esac

netname=kbx-net
port=8765

if ! docker network ls | grep -q $netname ; then
    docker network --driver bridge $netname
fi

common_opts="--network $netname --rm --mount source=kbx-hello,target=/var/lib/kbx-hello"

case $component in
    server)
	# Make service available outside container?
	# opts="$opts --publish $port:$port"
	docker run $common_opts $opts --name kbx-hello-server --tty kbx-hello-server
	;;
    cli)
	docker run $common_opts --tty --interactive kbx-hello-cli --host kbx-hello-server
	;;
    gui)
	dispnum=$(echo $DISPLAY | cut -d: -f2 | cut -d. -f1)
	xhost +si:localuser:root
	# the --volume="$userhome/.Xauthority:/root/.Xauthority:rw" part seems unneeded with the xhost hack
	# TODO: find out how to avoid that hack
	docker run $common_opts --env=DISPLAY --volume="$userhome/.Xauthority:/root/.Xauthority:rw" --volume="/tmp/.X11-unix/X$dispnum:/tmp/.X11-unix/X$dispnum:rw" kbx-hello-gui --host kbx-hello-server
	;;
    *)
	echo "Unknown component"
	exit 1
	;;
esac
